# Планы по обновлению TamaFi

## Общая концепция

Реализация системы "Дупло/Норка" для хранения найденных Wi‑Fi сетей и Bluetooth устройств, а также предотвращения повторного использования одних и тех же источников для питания. Питомец может питаться как Wi‑Fi сетями, так и Bluetooth устройствами, найденными в радиусе действия.

---

## 1. Питомец не может питаться одной и той же сетью повторно

### Описание
Реализовать механизм отслеживания уже использованных Wi‑Fi сетей, чтобы питомец не мог питаться одной и той же сетью повторно при сканировании.

### Вопросы для изучения

#### 1.1. Идентификация сетей
- Какой уникальный идентификатор использовать для сетей?
  - SSID (может быть не уникальным, если несколько точек с одинаковым именем)
  - MAC-адрес точки доступа (BSSID) — более надежный вариант
  - Комбинация SSID + BSSID для максимальной точности
- Как обрабатывать скрытые сети (SSID пустой)?
  - Использовать только BSSID для скрытых сетей
  - Нужно ли различать скрытые сети с одинаковым BSSID?

#### 1.2. Механизм отслеживания
- Где хранить список использованных сетей?
  - В памяти (RAM) — быстрый доступ, но ограниченный объем
  - В NVS (Preferences) — постоянное хранение, но медленнее
  - Гибридный подход: активный список в RAM, архив в NVS
- Какой формат данных использовать?
  - Массив структур с SSID/BSSID
  - Хеш-таблица для быстрого поиска
  - Битовая карта (если количество сетей ограничено)

#### 1.3. Логика проверки
- Когда проверять, использовалась ли сеть?
  - При сканировании (до подсчета статистики)
  - При обработке результатов сканирования
  - В функции `resolveHunt()` и `resolveDiscover()`
- Что делать с уже использованными сетями?
  - Полностью игнорировать при подсчете
  - Учитывать, но с уменьшенным эффектом (например, 50% от обычного)
  - Показывать в статистике, но не использовать для питания

#### 1.4. Ограничения памяти
- Сколько сетей можно хранить на ESP32-S3?
  - Оценка размера одной записи (SSID ~32 байта + BSSID 6 байт + метаданные)
  - Доступная память NVS (обычно ~64KB)
  - Максимальное количество записей
- Что делать при переполнении?
  - FIFO (удалять самые старые)
  - LRU (удалять наименее используемые)
  - Очистка по времени (удалять сети старше N дней)

#### 1.5. Производительность
- Как оптимизировать поиск в списке?
  - Сортировка для бинарного поиска
  - Хеш-таблица для O(1) поиска
  - Кэширование последних проверок
- Влияние на время сканирования и обработки

---

## 2. Дупло/Норка для сохранения найденных сетей

### Описание
Создать виртуальное хранилище "Дупло/Норка", куда питомец будет складывать найденные Wi‑Fi сети и Bluetooth устройства для последующего использования.

### Вопросы для изучения

#### 2.1. Концепция и дизайн
- Как визуализировать Дупло/Норку в UI?
  - Отдельный экран/меню
  - Индикатор на главном экране (количество сохраненных сетей)
  - Анимация "складывания" сети в норку
- Какой термин использовать?
  - "Дупло" (более игриво)
  - "Норка" (более реалистично)
  - Позволить пользователю выбирать в настройках

#### 2.2. Механизм сохранения
- Когда питомец сохраняет сети и устройства в Дупло?
  - Автоматически при каждом сканировании (все новые Wi‑Fi сети и Bluetooth устройства)
  - Только при успешной охоте/исследовании
  - По решению питомца (на основе любопытства/активности)
  - Пользователь может вручную добавить через меню
- Какие сети и устройства сохранять?
  - Все найденные Wi‑Fi сети и Bluetooth устройства
  - Только сильные источники (RSSI > -70 для Wi‑Fi, RSSI > -80 для Bluetooth)
  - Только интересные (скрытые Wi‑Fi, открытые Wi‑Fi, BLE устройства с сервисами, с хорошим сигналом)
  - Настраиваемый фильтр для каждого типа источника

#### 2.3. Структура данных
- Какая информация хранится о каждой сети/устройстве?
  - **Для Wi‑Fi сетей:**
    - SSID (если не скрытая)
    - BSSID (MAC-адрес)
    - RSSI на момент обнаружения
    - Тип шифрования (open/WPA/WPA2)
  - **Для Bluetooth устройств:**
    - Имя устройства (если доступно)
    - MAC-адрес (BD_ADDR)
    - RSSI на момент обнаружения
    - Тип устройства (BLE Classic/BLE/оба)
    - Список сервисов (если BLE)
  - **Общие поля:**
    - Тип источника (Wi‑Fi/Bluetooth)
    - Дата/время первого обнаружения
    - Количество использований
    - Последний RSSI (обновляется при повторном обнаружении)
- Формат хранения в NVS
  - JSON-подобная структура
  - Бинарный формат для экономии места
  - Разделение на "активные" и "архивные" источники
  - Раздельное хранение Wi‑Fi и Bluetooth или единая структура?

#### 2.4. Управление хранилищем
- Как организовать интерфейс управления?
  - Список сохраненных сетей и устройств с возможностью просмотра
  - Фильтры (по типу источника, силе сигнала, типу, дате)
  - Поиск по SSID/имени устройства
  - Удаление источников вручную
  - Группировка по типу (Wi‑Fi/Bluetooth) или смешанный список
- Автоматическая очистка
  - Удаление источников, которые не обнаруживаются N дней
  - Удаление при переполнении (старые/слабые первыми)
  - Настройка лимита хранения (общий или отдельный для Wi‑Fi/Bluetooth)

#### 2.5. Визуальная обратная связь
- Анимации и эффекты
  - Анимация "складывания" сети/устройства в норку
  - Индикатор заполненности (например, "15/50 источников" или "Wi‑Fi: 10, BT: 5")
  - Визуализация содержимого норки (список, иконки, разделение по типам)
  - Разные иконки для Wi‑Fi сетей и Bluetooth устройств
- Звуковые эффекты
  - Звук при добавлении сети/устройства
  - Разные звуки для Wi‑Fi и Bluetooth
  - Звук при переполнении
  - Звук при использовании источника из норки

---

## 3. Питание из Дупло/Норка сохраненными сетями

### Описание
Реализовать механизм, при котором питомец может питаться сетями, сохраненными в Дупло/Норке, даже если эти сети не обнаружены при текущем сканировании.

### Вопросы для изучения

#### 3.1. Механизм питания из норки
- Как питомец выбирает сети из норки?
  - Случайный выбор
  - По силе сигнала (самые сильные первыми)
  - По давности (старые первыми, чтобы освободить место)
  - По типу (разнообразие: открытые, скрытые, защищенные)
  - Комбинированный алгоритм (сила + разнообразие + давность)
- Сколько сетей использовать за раз?
  - Одна сеть за охоту
  - Несколько сетей (например, 3-5)
  - Все доступные (с ограничением по эффекту)

#### 3.2. Эффективность питания
- Какой эффект от сетей из норки?
  - Такой же, как при прямом сканировании
  - Уменьшенный эффект (например, 70-80% от обычного)
  - Зависит от давности сохранения (старые сети менее питательны)
  - Зависит от последнего RSSI (слабые сети менее питательны)
- Как учитывать RSSI сохраненных сетей?
  - Использовать RSSI на момент сохранения
  - Обновлять RSSI при повторном обнаружении
  - Эмулировать ослабление сигнала со временем

#### 3.3. Логика принятия решений
- Когда питомец использует норку вместо сканирования?
  - Когда нет сетей при сканировании
  - Когда все найденные сети уже использованы
  - Когда питомец голоден, а сканирование не дало результатов
  - Как дополнительный источник питания (вместе со сканированием)
- Как интегрировать с существующей системой решений?
  - Новая активность `ACT_FEED_FROM_DEN`
  - Модификация `resolveHunt()` для использования норки
  - Гибридный подход: сканирование + норка одновременно

#### 3.4. Обновление информации о сетях
- Что делать, если сохраненная сеть обнаружена снова?
  - Обновить RSSI
  - Обновить дату последнего обнаружения
  - Сбросить флаг "использована" (если сеть снова доступна)
  - Увеличить счетчик использований
- Как обрабатывать сети, которые больше не обнаруживаются?
  - Помечать как "недоступные"
  - Удалять после N дней отсутствия
  - Использовать с уменьшенным эффектом (эмуляция слабого сигнала)

#### 3.5. Балансировка источников питания
- Как балансировать между сканированием и норкой?
  - Приоритет сканированию (свежие сети лучше)
  - Норка как резервный источник
  - Комбинирование: сканирование для разнообразия, норка для стабильности
- Влияние на игровой баланс
  - Не сделать питомца слишком "сытым" с норкой
  - Сохранить мотивацию к исследованию новых мест
  - Награда за накопление сетей в норке

#### 3.6. UI и обратная связь
- Как показывать использование норки?
  - Индикатор на экране охоты ("Питается из норки")
  - Анимация "доставания" сети/устройства из норки
  - Счетчик использованных источников из норки
  - Статистика в меню (сколько раз использовалась норка, раздельно по Wi‑Fi/Bluetooth)
- Визуализация содержимого норки
  - Список сетей и устройств с SSID/именем (если доступно)
  - Индикатор силы сигнала
  - Дата сохранения
  - Статус (использована/доступна)
  - Иконка типа источника (Wi‑Fi/Bluetooth)

---

## 4. Питание питомца Bluetooth устройствами

### Описание
Реализовать механизм питания питомца через Bluetooth устройства, найденные в радиусе действия. Найденные Bluetooth устройства также сохраняются в Дупло/Норку для последующего использования.

### Вопросы для изучения

#### 4.1. Сканирование Bluetooth устройств
- Какой тип Bluetooth сканирования использовать?
  - Bluetooth Classic (BR/EDR) — старые устройства, больше энергии
  - Bluetooth Low Energy (BLE) — современные устройства, меньше энергии
  - Оба типа одновременно или по выбору пользователя
- Как организовать сканирование?
  - Асинхронное сканирование (аналогично Wi‑Fi)
  - Параллельное сканирование Wi‑Fi и Bluetooth
  - Последовательное сканирование (сначала Wi‑Fi, потом Bluetooth)
  - Настраиваемый приоритет
- Параметры сканирования
  - Длительность сканирования
  - Интервал между сканированиями
  - Активное или пассивное сканирование (влияет на энергопотребление)

#### 4.2. Идентификация Bluetooth устройств
- Какой уникальный идентификатор использовать?
  - MAC-адрес (BD_ADDR) — основной идентификатор
  - Имя устройства (может изменяться, не уникально)
  - Комбинация MAC + тип устройства
  - Service UUID для BLE устройств (если доступен)
- Как обрабатывать устройства с изменяемым MAC-адресом (MAC randomization)?
  - Использовать статический MAC, если доступен
  - Группировать по имени устройства
  - Использовать комбинацию параметров для идентификации

#### 4.3. Структура данных Bluetooth устройств
- Какая информация собирается о каждом устройстве?
  - MAC-адрес (BD_ADDR)
  - Имя устройства (если доступно)
  - RSSI (сила сигнала)
  - Тип устройства (BLE Classic/BLE/оба)
  - Класс устройства (если доступен)
  - Список сервисов (для BLE)
  - Тип соединения (подключено/рекламируется)
- Дополнительные метаданные
  - Дата/время первого обнаружения
  - Количество использований
  - Последний RSSI
  - Частота обнаружения (как часто устройство видно)

#### 4.4. Механизм питания через Bluetooth
- Как рассчитывать эффект от Bluetooth устройств?
  - По количеству устройств (аналогично Wi‑Fi сетям)
  - По силе сигнала (RSSI)
  - По типу устройства (BLE Classic дает больше, чем BLE?)
  - По количеству сервисов (для BLE)
  - Комбинированная формула
- Сравнение с Wi‑Fi питанием
  - Bluetooth устройства дают больше/меньше/равно Wi‑Fi?
  - Разные параметры влияют по-разному (голод/счастье/здоровье)?
  - Разнообразие типов устройств влияет на счастье?

#### 4.5. Интеграция с системой решений
- Как интегрировать Bluetooth в существующую систему активностей?
  - Новая активность `ACT_HUNT_BT` или `ACT_DISCOVER_BT`
  - Модификация существующих активностей для поддержки Bluetooth
  - Универсальная активность, работающая с обоими типами источников
- Логика принятия решений
  - Когда питомец предпочитает охотиться на Bluetooth вместо Wi‑Fi?
  - Комбинированная охота (Wi‑Fi + Bluetooth одновременно)
  - Приоритеты на основе настроения и параметров питомца

#### 4.6. Сохранение Bluetooth устройств в Дупло
- Когда сохранять Bluetooth устройства?
  - Автоматически при каждом сканировании
  - Только при успешной охоте/исследовании
  - По критериям (сильный сигнал, интересные сервисы)
- Какие устройства сохранять?
  - Все обнаруженные
  - Только с сильным сигналом (RSSI > -80)
  - Только с интересными характеристиками (BLE с сервисами, классические устройства)
  - Фильтрация по типу устройства (телефоны, наушники, умные часы и т.д.)

#### 4.7. Питание из норки Bluetooth устройствами
- Как выбирать Bluetooth устройства из норки?
  - Случайный выбор
  - По силе сигнала
  - По давности сохранения
  - По типу устройства (разнообразие)
  - Комбинированный алгоритм
- Эффективность питания из норки
  - Такой же эффект, как при прямом обнаружении?
  - Уменьшенный эффект (аналогично Wi‑Fi)?
  - Зависит от давности и последнего RSSI?
- Обновление информации
  - Обновление RSSI при повторном обнаружении
  - Сброс флага "использована" при обнаружении
  - Удаление устройств, которые не обнаруживаются N дней

#### 4.8. Энергопотребление
- Влияние Bluetooth сканирования на батарею
  - Сравнение энергопотребления Wi‑Fi и Bluetooth сканирования
  - Оптимизация частоты сканирования
  - Режимы энергосбережения
- Балансировка между функциональностью и автономностью
  - Настройки частоты сканирования Bluetooth
  - Отключение Bluetooth сканирования для экономии энергии
  - Адаптивная частота (чаще при низком заряде батареи?)

#### 4.9. UI и визуализация
- Как показывать Bluetooth сканирование и питание?
  - Индикатор на экране охоты ("Охотится на Bluetooth...")
  - Анимация обнаружения Bluetooth устройств
  - Разные визуальные эффекты для Wi‑Fi и Bluetooth
- Отображение в меню и статистике
  - Количество найденных Bluetooth устройств
  - Список сохраненных устройств в Дупло
  - Статистика использования Bluetooth для питания
  - Разделение или объединение статистики Wi‑Fi и Bluetooth

#### 4.10. Совместимость и ограничения
- Поддержка различных версий Bluetooth на ESP32-S3
  - Bluetooth Classic (BR/EDR)
  - Bluetooth Low Energy (BLE 4.0, 4.2, 5.0)
  - Ограничения ESP32-S3 по одновременной работе Wi‑Fi и Bluetooth
- Обработка ошибок
  - Что делать при сбое Bluetooth стека?
  - Восстановление после ошибок сканирования
  - Fallback на Wi‑Fi при проблемах с Bluetooth

---

## 5. Доработка управления через тач-экран

### Описание
Расширить и доработать управление питомцем через тач-экран (если аппаратно доступен): навигация по меню, жесты, подтверждения действий, взаимодействие с элементами UI без физических кнопок.

### Вопросы для изучения

#### 5.1. Аппаратные и библиотечные ограничения
- Какой тип тач-экрана используется (резистивный/емкостный, однопальцевый/многопальцевый)?
- Какая библиотека/драйвер используется для работы с тачем и как она интегрируется с `TFT_eSPI`?
- Поддерживается ли аппаратно мультитач, жесты или только координаты касания?

#### 5.2. Модель ввода и UX
- Какую модель ввода выбрать:
  - Эмуляция кнопок (тач-зоны, соответствующие UP/OK/DOWN и правым кнопкам)
  - Полноценные тач-элементы (кнопки, списки, слайдеры)
  - Жесты (свайпы для смены экранов, долгие тапы для контекстных действий)?
- Как обеспечить удобство в карманном формате:
  - Минимальный размер тач-элементов
  - Защита от случайных нажатий (долгий тап, подтверждение)
  - Вибрация/звук в качестве обратной связи?

#### 5.3. Архитектура ввода
- Как лучше интегрировать тач-события в существующую логику:
  - Добавить абстрактный слой `Input` (buttons + touch)
  - Оставить текущую логику кнопок и поверх маппить тач-зоны на кнопки
  - Вынести всю обработку ввода в отдельный модуль
- Как обрабатывать конкуренцию между кнопками и тачем:
  - Приоритет тач-ввода
  - Режим \"только тач\" / \"тач + кнопки\"

#### 5.4. Навигация по меню и экранам
- Как реализовать навигацию по меню с помощью тач-экрана:
  - Тап по пункту меню
  - Свайпы для прокрутки/переключения экранов
  - Скроллинг списков (например, содержимое Дупла/Норки)?
- Как визуально подсвечивать выбранные элементы при тач-взаимодействии:
  - Ховер/прес-анимации
  - Обратная связь цветом/рамкой

#### 5.5. Настройки и режимы управления
- Нужен ли отдельный раздел настроек для управления:
  - Режим ввода: \"Только кнопки\" / \"Только тач\" / \"Смешанный\"
  - Чувствительность тач-экрана
  - Включение/отключение жестов (свайпы, долгий тап)
- Как сохранять и загружать эти настройки (через `Preferences`)?

#### 5.6. Тестирование UX
- Как тестировать удобство управления:
  - Проверка точности нажатий на физических устройствах
  - Тестирование в перчатках/на морозе (если актуально)
  - Тесты на случайные касания в кармане
- Как собирать фидбек от пользователей:
  - Логирование частоты ошибок ввода
  - Встроенные подсказки/туториал по жестам

---

## Общие технические вопросы

### Производительность и память
- Оптимизация использования NVS
- Кэширование часто используемых данных в RAM
- Эффективные алгоритмы поиска и сортировки

### Совместимость
- Миграция данных при обновлении прошивки
- Обратная совместимость с существующими сохранениями
- Версионирование структуры данных

### Тестирование
- Тестирование с различным количеством сетей и Bluetooth устройств
- Тестирование переполнения хранилища
- Тестирование производительности при большом количестве записей
- Тестирование одновременной работы Wi‑Fi и Bluetooth сканирования
- Тестирование энергопотребления при активном Bluetooth сканировании

---

## Приоритеты реализации

1. **Высокий приоритет**: 
   - Базовая идентификация сетей (BSSID), хранение в NVS, проверка на повторное использование
   - Базовая идентификация Bluetooth устройств (MAC-адрес), сканирование BLE
2. **Средний приоритет**: 
   - UI для Дупло/Норки, механизм сохранения сетей и устройств
   - Интеграция Bluetooth питания в систему решений
3. **Низкий приоритет**: 
   - Продвинутые функции (автоочистка, фильтры, статистика)
   - Поддержка Bluetooth Classic, оптимизация энергопотребления

---

*Дата создания: 23 января 2026*
*Статус: Планирование*
