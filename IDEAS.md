# Планы по обновлению TamaFi

## Целевое устройство

**WAVESHARE ESP32-S3 1.8" AMOLED** (MiiBestOD/Spotpear ESP32-S3-Touch-AMOLED-1.8)

| Компонент | Характеристика |
|-----------|----------------|
| MCU | ESP32-S3 (Wi-Fi + BLE 5.0) |
| Дисплей | SH8601 AMOLED 368×448 (QSPI) |
| Тач | FT3168 (ёмкостный, I2C) |
| Звук | ES8311 I2S кодек + PA (GPIO46) |
| Питание | AXP2101 PMIC (I2C) |
| Кнопки | BOOT (GPIO0), PWR (через TCA9554 I2C) |
| Ввод | Тач-зоны (UP / OK / DOWN) + двойной тап → R1 |

---

## Текущий статус реализации

### Реализовано

- **Логика питомца** — голод, счастье, здоровье; стадии (Baby → Teen → Adult → Elder); настроения; личностные черты (curiosity, activity, stress); автономное принятие решений; система отдыха; смерть
- **Wi-Fi сканирование и кормление** — асинхронное сканирование, охота (ACT_HUNT), исследование (ACT_DISCOVER), инъекция результатов в логику питомца
- **UI/навигация** — 8 экранов (Boot, Hatch, Home, Menu, Pet Status, System Info, Settings, Game Over); анимации спрайтов; полоски статов; индикатор батареи
- **Тач-ввод** — FT3168; три зоны (UP / OK / DOWN) в нижней полосе 368×80; двойной тап на OK → R1 (быстрый доступ к Pet Status)
- **Звук** — ES8311 I2S (основной) + PWM fallback; секвенсер; 10 звуковых эффектов; 4 уровня громкости; сохранение в NVS
- **Сохранение** — Preferences (NVS), namespace "tamafi2"; автосохранение (15s/30s/60s); все статы, возраст, стадия, черты, настройки
- **Батарея** — AXP2101 PMIC; заряд %, напряжение, статус зарядки, USB; индикатор на экране; опрос каждые 5 сек
- **Настройки** — яркость, громкость, скин питомца, Auto Sleep, Auto Save, сброс питомца, полный сброс

### Не реализовано

- Запрет повторного питания одной сетью (раздел 1)
- Дупло/Норка — хранилище найденных сетей и устройств (раздел 2)
- Питание из Дупло/Норки (раздел 3)
- Bluetooth/BLE сканирование и питание (раздел 4)
- Подключение спрайтов под разные скины питомца (UI настройки есть, ассеты не подключены)
- ~~Auto Sleep~~ — **реализовано** (раздел 6): выключение экрана и звука по таймеру / кнопке BOOT
- Погладить питомца — тап по спрайту на Home (раздел 7)
- Ручное кормление — принудительный запуск WiFi-охоты (раздел 8)
- Игра с питомцем — действие «Поиграть» (раздел 9)
- Лечение питомца — дать лекарство при болезни (раздел 10)
- Мини-игра «Поймай сигнал» — рефлекс-игра (раздел 11)
- Реакция на жесты — свайпы, долгий тап (раздел 12)
- Воспитание питомца — похвала/ругание, влияние на traits (раздел 13)

---

## 1. Питомец не может питаться одной и той же сетью повторно

**Статус: не реализовано**

### Описание
Реализовать механизм отслеживания уже использованных Wi-Fi сетей, чтобы питомец не мог питаться одной и той же сетью повторно при сканировании.

### Решения по дизайну

#### 1.1. Идентификация сетей
- **BSSID (MAC-адрес точки доступа)** — наиболее надёжный уникальный идентификатор
- Скрытые сети (SSID пустой) — идентифицировать только по BSSID
- Хранить SSID для отображения в UI, но для сравнения использовать BSSID

#### 1.2. Механизм отслеживания
- Гибридный подход: активный список в RAM + архив в NVS
- Хеш-таблица по BSSID для быстрого поиска O(1)
- При переполнении — FIFO (удалять самые старые записи)

#### 1.3. Логика проверки
- Проверка в `resolveHunt()` и `resolveDiscover()` — до подсчёта статистики
- Использованные сети показывать в статистике, но не учитывать для питания
- Сеть считается "использованной" после успешной охоты/исследования

#### 1.4. Ограничения памяти (ESP32-S3)
- Размер записи: BSSID (6 байт) + метаданные (~10 байт) ≈ 16 байт
- NVS доступно ~64KB → можно хранить тысячи записей
- Лимит: ~500 записей (с запасом), FIFO при переполнении

---

## 2. Дупло/Норка для сохранения найденных источников

**Статус: не реализовано**

### Описание
Виртуальное хранилище "Дупло", куда питомец складывает найденные Wi-Fi сети и Bluetooth устройства для последующего использования.

### Дизайн

#### 2.1. Концепция
- Отдельный экран в меню — "Дупло" (Den)
- Индикатор на главном экране — количество сохранённых источников
- Анимация "складывания" источника в дупло

#### 2.2. Механизм сохранения
- Автоматически при каждом успешном сканировании — все новые Wi-Fi сети и BLE устройства
- Фильтр: только источники с сильным сигналом (Wi-Fi RSSI > -70, BLE RSSI > -80)
- Раздельное хранение Wi-Fi и Bluetooth

#### 2.3. Структура данных

**Wi-Fi сеть:**
- SSID (до 32 байт)
- BSSID (6 байт)
- RSSI на момент обнаружения
- Тип шифрования (open/WPA/WPA2)
- Дата первого обнаружения
- Количество использований
- Последний RSSI

**Bluetooth устройство:**
- Имя (если доступно)
- MAC-адрес (6 байт)
- RSSI на момент обнаружения
- Тип (BLE/Classic)
- Дата первого обнаружения
- Количество использований
- Последний RSSI

**Формат хранения:** бинарный в NVS, раздельные пространства для Wi-Fi и Bluetooth

#### 2.4. Управление хранилищем
- Список с возможностью прокрутки (тач-свайп вверх/вниз)
- Фильтры: по типу (Wi-Fi / Bluetooth), по силе сигнала
- Автоочистка: удаление источников старше 30 дней
- Лимит: ~200 записей (Wi-Fi + Bluetooth суммарно)

#### 2.5. Визуальная обратная связь
- Анимация добавления в дупло
- Индикатор заполненности ("45/200 источников")
- Разные иконки для Wi-Fi и Bluetooth
- Звук при добавлении (`sndDenStore()`) и при переполнении (`sndDenFull()`)

---

## 3. Питание из Дупло сохранёнными источниками

**Статус: не реализовано**

### Описание
Питомец может питаться источниками из Дупло, когда текущее сканирование не дало результатов или все найденные сети уже использованы.

### Дизайн

#### 3.1. Механизм питания
- Новая активность `ACT_FEED_FROM_DEN`
- Выбор источника: комбинированный алгоритм (сила сигнала + давность + разнообразие типов)
- За одну "кормёжку" — 1–3 источника

#### 3.2. Эффективность
- Уменьшенный эффект: 70% от прямого сканирования
- Давность влияет: источники старше 7 дней — 50% эффекта
- RSSI на момент сохранения определяет базовый эффект

#### 3.3. Логика использования
- Когда питомец голоден, а сканирование не дало новых сетей
- Когда все найденные сети уже использованы (раздел 1)
- Как дополнительный источник (вместе со сканированием, но с меньшим эффектом)

#### 3.4. Обновление информации
- При повторном обнаружении — обновить RSSI и дату
- Сбросить флаг "использована" при повторном обнаружении
- Удалить из дупла, если не обнаруживается 30+ дней

#### 3.5. Баланс
- Приоритет — живое сканирование (свежие сети всегда лучше)
- Дупло — резервный источник, не заменяет исследование
- Мотивация к перемещению: старые источники теряют ценность со временем

#### 3.6. UI
- Индикатор на экране охоты: "Питается из дупла"
- Анимация "доставания" из дупла
- Счётчик использований в экране Дупло
- Статистика: сколько раз кормился из дупла (раздельно Wi-Fi/BT)

---

## 4. Питание питомца Bluetooth устройствами

**Статус: не реализовано**

### Описание
Питомец может питаться BLE устройствами, найденными в радиусе действия ESP32-S3. Устройства также сохраняются в Дупло.

### Дизайн

#### 4.1. Сканирование
- **Только BLE (Bluetooth Low Energy)** — ESP32-S3 поддерживает BLE 5.0, энергоэффективно
- Асинхронное сканирование (аналогично Wi-Fi)
- Последовательно: сначала Wi-Fi, потом BLE (избежать конфликтов радио)
- Длительность BLE-скана: 3–5 секунд
- Пассивное сканирование по умолчанию (меньше энергии)

#### 4.2. Идентификация устройств
- **MAC-адрес** — основной идентификатор
- Проблема MAC randomization: группировать по имени устройства, если MAC меняется
- Для устройств без имени и с рандомным MAC — использовать только как "одноразовый" источник

#### 4.3. Данные об устройствах
- MAC-адрес (6 байт)
- Имя (если доступно, до 32 байт)
- RSSI
- Тип адреса (public/random)
- Дата обнаружения
- Количество использований

#### 4.4. Эффект питания
- По количеству устройств (аналогично Wi-Fi)
- RSSI влияет на силу эффекта
- BLE устройство ≈ Wi-Fi сеть по ценности (одинаковый баланс)
- Разнообразие типов (Wi-Fi + BLE) даёт бонус к счастью

#### 4.5. Интеграция с активностями
- Модификация `ACT_HUNT` — охота сканирует Wi-Fi + BLE последовательно
- Модификация `ACT_DISCOVER` — исследование учитывает BLE устройства
- Результаты BLE инъектируются через `petInjectBleResult()` (аналогично `petInjectWifiResult()`)

#### 4.6. Энергопотребление
- BLE-скан значительно экономичнее Wi-Fi
- Настройка в Settings: включить/выключить BLE-сканирование
- При низком заряде батареи (<20%) — автоматическое отключение BLE-скана

#### 4.7. UI
- Индикатор на экране охоты: "Обнаружено BLE: N"
- В System Info: количество BLE устройств, статус BLE
- В Дупле: иконка Bluetooth, фильтр по типу
- Анимация обнаружения BLE — отличается от Wi-Fi (другой цвет/эффект)

---

## 5. Доработка управления через тач-экран

**Статус: базовая реализация выполнена**

### Что реализовано
- FT3168 ёмкостный тач (I2C), однопальцевый
- Три тач-зоны в нижней полосе 368×80: UP (0–122px) / OK (123–245px) / DOWN (246–368px)
- Двойной тап на OK → INPUT_R1 (быстрый доступ к Pet Status)
- Физическая кнопка BOOT (GPIO0) и PWR (TCA9554) — не используются активно в навигации

### Что можно улучшить

#### 5.1. Жесты
- Свайп вверх/вниз — прокрутка в списках (Дупло, настройки)
- Свайп влево/вправо — переключение между экранами
- Долгий тап — контекстные действия (например, удаление из Дупла)

#### 5.2. Взаимодействие с питомцем
- Тап по спрайту питомца на Home-экране — реакция (анимация, звук, бонус к счастью)
- Контекстное меню при долгом тапе по питомцу (погладить, покормить из дупла)

#### 5.3. Использование физических кнопок
- BOOT — переключение режима (тач вкл/выкл) или спецфункция
- PWR — долгое нажатие для засыпания, короткое — пробуждение

#### 5.4. Улучшения UX
- Визуальная обратная связь при тапе (подсветка зоны, ripple-эффект)
- Звуковая обратная связь уже реализована (`sndBeep()`, `sndBeepOk()`)
- Защита от случайных касаний: lockscreen или требование двойного тапа для пробуждения

---

## 6. Auto Sleep и энергосбережение

**Статус: реализовано**

### Реализация
Выключение AMOLED дисплея и звука после настраиваемого таймаута бездействия. Логика питомца, Wi-Fi сканирование и автосохранение продолжают работать.

#### Засыпание
- По таймеру бездействия: настраиваемый таймаут (Off / 30s / 60s / 120s) в Settings → Auto Sleep
- По кнопке BOOT — мгновенный переход в сон
- При засыпании: дисплей выключен (яркость 0), звук отключён, отрисовка UI пропускается

#### Пробуждение
- Любое касание тач-экрана (первое касание пробуждает, не передаётся в навигацию)
- Нажатие кнопки BOOT
- Яркость восстанавливается до пользовательской настройки (Low/Mid/High)

#### Что продолжает работать во сне
- Логика питомца (голод, счастье, здоровье, автономные решения)
- Wi-Fi сканирование и кормление
- Автосохранение в NVS
- Опрос батареи

#### Персистенция
- Таймаут Auto Sleep сохраняется в NVS (ключ `sleepMs`)

---

## Общие технические вопросы

### Производительность и память (ESP32-S3)
- NVS: namespace "tamafi2", ~64KB доступно
- Кэширование Дупла в RAM при открытии экрана, запись в NVS при изменении
- Хеш-таблицы для быстрого поиска по BSSID/MAC

### Совместимость данных
- Версионирование структуры NVS (поле `dataVersion`)
- Миграция при обновлении прошивки (старые поля сохраняются, новые заполняются defaults)

### Тестирование
- Тестирование с различным количеством Wi-Fi сетей и BLE устройств
- Тестирование переполнения Дупла
- Тестирование энергопотребления при активном BLE-скане
- Тестирование одновременной работы Wi-Fi + BLE (последовательное сканирование)
- Тестирование Auto Sleep / пробуждение

---

## 7. Погладить питомца (Pet Petting)

**Статус: не реализовано**

### Описание
Тап по области спрайта питомца на Home-экране вызывает короткую анимацию (сердечки / звёзды), приятный звук и небольшой бонус к happiness.

### Дизайн

#### 7.1. Ввод
- Расширить обработку тача в `input.cpp` — распознавать тапы в контентной зоне (y < CONTENT_H), а не только в нижней полосе управления
- Маппить координаты тача на логические координаты контента (368→240) и проверять попадание в область спрайта питомца (petPosX ± PET_W/2, petPosY ± PET_H/2)
- Новое событие `INPUT_PET_TAP` или отдельный флаг в input

#### 7.2. Команда и логика
- Новая команда `PET_CMD_PET` → в `processCommands()` добавить обработку: +5..+10 happiness, кулдаун 5–10 секунд
- Если питомец болен (MOOD_SICK) — меньший эффект (+2..+3)
- Если питомец спит (ACT_REST) — игнорировать или показать "Zzz" без эффекта
- Если кулдаун не прошёл — без эффекта, но с лёгкой анимацией

#### 7.3. Визуальная обратная связь
- Оверлей-анимация: сердечки (3–4 кадра, 100–150 мс каждый) поверх спрайта питомца
- По аналогии с `hungerEffectActive` — флаг `petEffectActive`, `petEffectFrame`, `lastPetEffectTime`
- Звук: `sndPet()` — короткий приятный звук (новая мелодия в `sound.cpp`)

#### 7.4. Сложность и приоритет
- **Сложность**: низкая
- **Приоритет**: высокий — минимум кода, максимум ощутимого интерактива

---

## 8. Ручное кормление (Manual Feed)

**Статус: не реализовано**

### Описание
Пользователь может вручную запустить WiFi-охоту вместо ожидания автономного решения питомца. Доступно с Home-экрана или через пункт меню.

### Дизайн

#### 8.1. Вход
- Быстрый доступ: отдельная тач-зона на Home-экране (например, долгий тап по контентной области) или новый жест
- Альтернативно: пункт «Feed Now» в главном меню

#### 8.2. Команда и логика
- Новая команда `PET_CMD_FEED` → принудительно устанавливает `activity = ACT_HUNT` и генерирует `PET_EVT_WIFI_REQUEST`
- Кулдаун: не чаще раза в 30 секунд (глобальный таймер `lastManualFeedTime`)
- Если питомец уже в активности (ACT_HUNT, ACT_DISCOVER, ACT_REST) — игнорировать с визуальным уведомлением

#### 8.3. Визуальная обратная связь
- При запуске: короткая анимация «зов на охоту» + звук `sndFeedCall()`
- При кулдауне: показать оставшееся время или текст "Wait..."
- Обычная анимация охоты (ATTACK_FRAMES) после запуска сканирования

#### 8.4. Сложность и приоритет
- **Сложность**: низкая
- **Приоритет**: высокий — даёт контроль, особенно когда питомец голоден

---

## 9. Игра с питомцем (Play)

**Статус: не реализовано**

### Описание
Действие «Поиграть» — запускает короткую анимацию взаимодействия, даёт бонус к happiness, но расходует немного hunger.

### Дизайн

#### 9.1. Вход
- Пункт в главном меню «Play» или быстрый доступ через жест с Home-экрана

#### 9.2. Команда и логика
- Новая команда `PET_CMD_PLAY` и активность `ACT_PLAY`
- Эффект: +10..+20 happiness, -5..+10 hunger (играть на пустой желудок — больше расход)
- Кулдаун: 30–60 секунд
- Питомец может **отказаться**, если: MOOD_SICK, hunger < 15, ACT_REST — добавляет «характер»
- При отказе: анимация «отворачивается» + звук `sndRefuse()`

#### 9.3. Визуальная обратная связь
- Анимация игры: 2–3 секунды, питомец прыгает/крутится (новый набор спрайтов или переиспользование существующих с эффектами)
- Звук: `sndPlay()` — весёлая мелодия
- Оверлей: звёздочки / нотки вокруг питомца

#### 9.4. Сложность и приоритет
- **Сложность**: низкая–средняя (нужны спрайты анимации)
- **Приоритет**: средний — классика тамагочи

---

## 10. Лечение питомца (Give Medicine)

**Статус: не реализовано**

### Описание
Когда питомец болен (MOOD_SICK, health < 25), пользователь может «дать лекарство» для частичного восстановления здоровья.

### Дизайн

#### 10.1. Условие доступности
- Доступно только когда: health < 40 или MOOD_SICK
- Недоступно при: ACT_REST (спит) или isDead

#### 10.2. Команда и логика
- Новая команда `PET_CMD_MEDICINE`
- Эффект: +15..+20 health
- Кулдаун: 2 минуты
- Уменьшающаяся эффективность: первое применение +20, второе +15, третье +10 (сброс через 10 минут)

#### 10.3. Визуальная обратная связь
- Анимация: оверлей с крестиком/пузырьками (3–4 кадра)
- Звук: `sndMedicine()` — характерный звук лечения
- При попытке в кулдауне: текст "Too soon..." или аналогичный

#### 10.4. Сложность и приоритет
- **Сложность**: низкая
- **Приоритет**: средний — полезный инструмент заботы в критических ситуациях

---

## 11. Мини-игра «Поймай сигнал» (Catch the Signal)

**Статус: не реализовано**

### Описание
Рефлекс-игра: иконки WiFi-сетей «падают» по трём полосам, пользователь тапает UP/OK/DOWN чтобы поймать. Результат влияет на hunger/happiness.

### Дизайн

#### 11.1. Экран и вход
- Новый `SCREEN_MINIGAME`, вход из главного меню (пункт «Mini-Game») или по специальному жесту с Home
- Длительность: 15–20 секунд за раунд

#### 11.2. Геймплей
- Три колонки (Left / Center / Right), привязаны к тач-зонам UP / OK / DOWN
- Иконки WiFi (разных цветов/размеров) падают сверху с переменной скоростью
- Нажатие в правильной колонке в момент, когда иконка в зоне «ловли» (нижняя 1/4 экрана) — +1 очко
- Промахи и пропуски — −1 очко (минимум 0)
- Бонусные иконки (золотые) — +3 очка

#### 11.3. Результат
- 0–5 очков: +5 happiness, −5 hunger (устал, не поймал)
- 6–15 очков: +15 happiness, +5 hunger (хорошая игра)
- 16+ очков: +25 happiness, +10 hunger (отлично!)
- Звук по окончании: `sndGameWin()` или `sndGameLose()`

#### 11.4. Сложность и приоритет
- **Сложность**: средняя (новый экран, игровой цикл, отрисовка падающих объектов)
- **Приоритет**: низкий — интересно, но требует больше работы

---

## 12. Реакция на жесты (Swipe Interactions)

**Статус: не реализовано**

### Описание
Свайпы по контентной области экрана вызывают реакции питомца: прыжок, перемещение, успокоение.

### Дизайн

#### 12.1. Распознавание жестов
- Расширить `input.cpp`: отслеживать dx/dy между touchStart и touchEnd в контентной зоне (y < CONTENT_H)
- Порог свайпа: минимум 40px перемещения
- Новые события: `INPUT_SWIPE_UP`, `INPUT_SWIPE_DOWN`, `INPUT_SWIPE_LEFT`, `INPUT_SWIPE_RIGHT`
- Долгий тап (> 500мс без перемещения): `INPUT_LONG_TAP`

#### 12.2. Реакции
- **Свайп вверх** → питомец подпрыгивает (смещение petPosY вверх и обратно, 3–4 кадра), +2 happiness
- **Свайп горизонтальный** → питомец перебегает в другую сторону экрана (смещение petPosX), +1 happiness
- **Долгий тап** → успокоение, если MOOD_EXCITED или MOOD_CURIOUS → MOOD_CALM, +3 health

#### 12.3. Сложность и приоритет
- **Сложность**: средняя (доработка input + анимации перемещения)
- **Приоритет**: низкий — делает тач-экран полезнее, но не критично

---

## 13. Воспитание питомца (Emotes / Discipline)

**Статус: не реализовано**

### Описание
Пользователь может «общаться» с питомцем — похвалить, пожурить, подбодрить. Влияет на mood и personality traits со временем.

### Дизайн

#### 13.1. Вход
- Подменю «Emote» из главного меню или быстрый доступ (тройной тап по OK?)
- Три варианта: Praise (похвала) / Neutral (нейтрально) / Scold (ругание)

#### 13.2. Эффект на traits (долгосрочный)
- **Praise**: +1 traitCuriosity (чаще, до макс. 95), +2 happiness, −1 traitStress
- **Scold**: +2 traitStress (до макс. 95), −3 happiness, +1 traitActivity (дисциплина)
- **Neutral**: −1 traitStress, +1 happiness (просто внимание)
- Кулдаун: 1 минута между эмоциями

#### 13.3. Последствия
- Высокий traitCuriosity → питомец чаще выбирает ACT_DISCOVER
- Высокий traitStress → питомец чаще выбирает ACT_REST, медленнее восстанавливает happiness
- Высокий traitActivity → чаще ACT_HUNT, быстрее расходуется hunger
- Баланс: пользователь «воспитывает» питомца, формируя его поведение

#### 13.4. Визуальная обратная связь
- Praise: сердечки + звук `sndPraise()`
- Scold: восклицательный знак + звук `sndScold()`
- Neutral: нотка + звук `sndNeutral()`

#### 13.5. Сложность и приоритет
- **Сложность**: средняя (UI выбора + влияние на traits + баланс)
- **Приоритет**: низкий — добавляет глубину, но требует тестирования баланса

---

## Приоритеты реализации

### Высокий приоритет
1. **Запрет повторного питания** — идентификация по BSSID, хранение в NVS, проверка в `resolveHunt()`
2. **Погладить питомца** — тап по спрайту на Home, минимум кода, максимум ощутимого интерактива
3. **Ручное кормление** — принудительный запуск WiFi-охоты, даёт контроль

### Средний приоритет
4. **Дупло/Норка** — хранение источников, UI экран, механизм сохранения
5. **Питание из Дупла** — активность `ACT_FEED_FROM_DEN`, интеграция с логикой питомца
6. **BLE сканирование** — базовое сканирование, интеграция с охотой/исследованием
7. **Игра с питомцем** — классика тамагочи, +happiness / −hunger
8. **Лечение питомца** — ручное восстановление health при болезни

### Низкий приоритет
9. **Мини-игра «Поймай сигнал»** — рефлекс-игра с падающими WiFi-иконками
10. **Жесты тач-экрана** — свайпы, долгий тап, реакции питомца
11. **Воспитание питомца** — похвала/ругание, влияние на traits
12. **Скины питомца** — подключение ассетов спрайтов к настройке `petSkin`
13. **Продвинутые функции Дупла** — автоочистка, фильтры, статистика, звуки

### Реализовано
- ~~**Auto Sleep**~~ — выключение экрана и звука по таймеру / кнопке BOOT (раздел 6)
- ~~**Управление через тач-экран**~~ — тач-зоны (UP/OK/DOWN), двойной тап → R1, кнопка BOOT (раздел 5)

---

*Дата создания: 23 января 2026*
*Последнее обновление: 14 февраля 2026*
*Статус: в разработке*
*Устройство: WAVESHARE ESP32-S3 1.8" AMOLED*
