---
description: Стратегия миграции на целевое устройство WAVESHARE_ESP32_S3_1.8_AMOLED
alwaysApply: true
---

# Стратегия миграции TamaFi на WAVESHARE_ESP32_S3_1.8_AMOLED

## Основной принцип

**При миграции мы переписываем код под целевое устройство. Старый код под прежнее железо можно и нужно заменять — не засорять проект условной компиляцией и развилками `if (deviceType == ...)`.**

### Ключевые требования:

1. **Код пишем под целевое устройство** — один целевой девайс (WAVESHARE_ESP32_S3_1.8_AMOLED), без поддержки старой платы в той же кодовой базе.
2. **Переписываем, а не оборачиваем** — дисплей, ввод, индикаторы, звук переписываются под новое железо; обертки с `if (deviceType)` не используем.
3. **Сохраняем только логику приложения** — игровая логика (питомец, WiFi-кормление, сохранение, эволюция, настроения) остаётся и при необходимости адаптируется по данным (размеры экрана, события ввода), но не дублируется ветками по типу устройства.
4. **Чистый код** — один путь выполнения под целевую плату, без лишних проверок типа устройства.

## Что переписываем при миграции

- **Дисплей:** замена TFT_eSPI (ST7789 240×240) на GFX_Library_for_Arduino + SH8601 (368×448). Инициализация, отрисовка, масштабирование контента 240×240 → 368×368 и область управления 368×80 — весь код под новое API.
- **Ввод:** замена шести физических кнопок на тач (FT3168) + две кнопки (BOOT, PWR). Код чтения кнопок и обработки тач-зон переписывается под целевое устройство.
- **Светодиоды:** NeoPixels на целевом устройстве нет — удаляем код LED, заменяем визуальной обратной связью на экране (индикаторы в области управления).
- **Звук:** при необходимости переписать под PWM/ES8311 целевой платы; общие вызовы звука (sndHatch и т.д.) можно оставить по смыслу, реализацию — под новое железо.
- **Инициализация:** один `setup()` под целевую плату — дисплей, тач, пины, без веток по типу устройства.

## Что сохраняем (логика и данные)

- **Логика питомца:** `logicTick()`, `resolveHunt()`, `resolveDiscover()`, таймеры голода/счастья/здоровья, эволюция, настроения — не трогаем по смыслу; при необходимости меняем только способ отображения или источник ввода (события кнопок/тач).
- **WiFi:** сканирование, использование результатов для «кормления» — без изменений логики.
- **Сохранение:** Preferences, `saveState()`, `loadState()` — без изменений.
- **Экраны и навигация:** те же экраны и переходы; отрисовка и ввод переписаны под новый дисплей и тач.

## Рекомендуемая структура после миграции

```
TamaFi/
├── TamaFi.ino           # Основной цикл, setup под целевое устройство
├── ui.cpp / ui.h        # Отрисовка под 368×448, область 368×80
├── input.cpp / input.h  # Тач + 2 кнопки (BOOT, PWR), маппинг в действия
├── device_config.h      # Пины, константы экрана (368×448, масштаб, зоны)
├── ...
```

Без `display_wrapper` с ветками по типу устройства и без `if (deviceType == ...)` в горячем коде.

## Чеклист при миграции

- [ ] Код собирается и запускается на WAVESHARE_ESP32_S3_1.8_AMOLED.
- [ ] Нет условной компиляции по типу устройства (или минимум, только выбор платы в среде сборки).
- [ ] Логика питомца, WiFi, сохранение не изменены по смыслу.
- [ ] Дисплей, ввод, индикаторы переписаны под целевое устройство, старый код под прежнее железо удалён.

## Роль AI ассистента

1. **Всегда спрашивать перед изменениями** — предлагать правки и ждать подтверждения.
2. **Ответственность за качество** — корректность миграции и работоспособность на целевом устройстве.
3. **Мелкие правки** — форматирование, комментарии, опечатки — по запросу с подтверждением.
4. **Приоритет** — чистый код под одно целевое устройство; не добавлять развилки для поддержки старой платы.
5. **Улучшения** — предлагать отдельно, не внедрять без подтверждения.
6. **Коммиты** — только по запросу пользователя.
7. **Баги** — предлагать: откатить или исправить; решать по месту.

### Перед изменением проверять

- [ ] Задача понята верно?
- [ ] Решение не вводит лишние ветки по типу устройства?
- [ ] Логика приложения (питомец, WiFi, сохранение) сохранена?
- [ ] Есть подтверждение пользователя на правки?

---

*Миграция выполняется под одно целевое устройство; старый код заменяется новым, кодовая база не засоряется развилками.*
